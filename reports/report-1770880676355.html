<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="pageTitle">聯絡人管理 / Contact Management</title>
    <!-- 引入 Tailwind CSS (本地測試時出現的警告不影響功能) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 SheetJS 用於匯出 Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-slide-up { 
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        @media (min-width: 768px) {
            .md\:animate-fade-in {
                animation: fadeIn 0.2s ease-out;
            }
        }
    </style>
</head>
<body class="p-4 md:p-10 pb-20">

    <div class="max-w-7xl mx-auto">
        <!-- 語言切換區 -->
        <div class="flex justify-end mb-4 gap-2">
            <button onclick="setLanguage('zh')" id="btn-zh" class="px-3 py-1 text-sm rounded-md font-medium transition-colors bg-blue-600 text-white shadow-sm">中文</button>
            <button onclick="setLanguage('en')" id="btn-en" class="px-3 py-1 text-sm rounded-md font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-sm">English</button>
        </div>

        <!-- 標題與操作區 -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4">
            <div>
                <img src="https://i.postimg.cc/vBNPcWBx/logo-foxlink-b-topaz-enhance-4x.png" alt="Company Logo" class="h-8 md:h-10 mb-3 object-contain select-none" onclick="handleLogoClick()">
                <h1 class="text-2xl font-bold text-gray-800" data-i18n="title">聯絡人列表</h1>
                <p class="text-sm text-gray-500 mt-1" data-i18n="subtitle">點擊聯絡人以查看詳細資訊或加入通訊錄</p>
            </div>
            
            <div class="flex flex-col sm:flex-row w-full md:w-auto gap-3">
                <!-- 搜尋框 -->
                <div class="relative w-full sm:w-64">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg aria-hidden="true" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" id="searchInput" oninput="handleSearch()" class="bg-white border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 md:py-3 shadow-sm transition-colors outline-none" placeholder="搜尋姓名或公司...">
                </div>

                <!-- 匯出按鈕 -->
                <button onclick="exportToExcel()" class="flex items-center justify-center w-full sm:w-auto gap-2 bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 md:py-3 rounded-lg shadow-sm transition-colors text-sm font-medium whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span data-i18n="exportBtn">匯出 XLSX (Excel)</span>
                </button>
            </div>
        </div>

        <!-- 表格區塊 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse" id="contactTable">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 border-b border-gray-200 text-sm uppercase tracking-wider">
                            <th class="p-3 md:p-4 font-medium" data-i18n="thName">姓名</th>
                            <th class="p-3 md:p-4 font-medium" data-i18n="thTitle">職位</th>
                            <th class="p-3 md:p-4 font-medium" data-i18n="thCompany">公司</th>
                            <th class="p-4 font-medium hidden md:table-cell" data-i18n="thPhone">電話</th>
                            <th class="p-4 font-medium hidden md:table-cell" data-i18n="thEmail">電子郵件</th>
                            <th class="p-4 font-medium hidden lg:table-cell" data-i18n="thAddress">地址</th>
                            <th class="p-3 md:hidden text-center w-8"></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm text-gray-700 divide-y divide-gray-100">
                        <!-- 資料將透過 JavaScript 動態生成 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 分頁控制器 -->
            <div id="pagination" class="flex flex-col sm:flex-row justify-between items-center p-4 border-t border-gray-100 bg-gray-50/50 gap-4 hidden">
                <span class="text-sm text-gray-600" id="pageInfo">顯示第 1 至 20 筆，共 0 筆</span>
                <div class="inline-flex rounded-md shadow-sm">
                    <button onclick="changePage(-1)" id="btnPrev" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" data-i18n="btnPrev">上一頁</button>
                    <button onclick="changePage(1)" id="btnNext" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-l-0 border-gray-200 rounded-r-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" data-i18n="btnNext">下一頁</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 聯絡人詳細資訊彈窗 (Modal) -->
    <div id="contactModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end md:items-center justify-center sm:p-4 transition-opacity duration-300" onclick="if(event.target === this) closeModal()">
        <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] animate-slide-up md:animate-fade-in relative">
             <div class="w-full flex justify-center pt-3 pb-1 md:hidden bg-white rounded-t-2xl absolute top-0 z-10" onclick="closeModal()">
                 <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
             </div>
             <div class="px-6 py-5 mt-4 md:mt-0 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-0">
                 <h3 class="text-xl font-bold text-gray-800 truncate pr-4" id="modalName">Name</h3>
                 <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2 -mr-2 rounded-full hover:bg-gray-100 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                 </button>
             </div>
             <div class="px-6 py-5 overflow-y-auto space-y-6 bg-white">
                 <div>
                     <p class="text-sm font-bold text-blue-600 mb-1 tracking-wide uppercase" id="modalCompany">Company</p>
                     <p class="text-base text-gray-700 font-medium" id="modalTitle">Title</p>
                 </div>
                 <hr class="border-gray-100">
                 <div class="space-y-3">
                     <!-- 電話區塊 -->
                     <div class="flex items-center gap-3 bg-gray-50/80 p-3 rounded-xl border border-gray-100">
                         <a id="modalPhoneLink" href="" class="flex-1 flex items-center gap-3 text-gray-800 hover:text-blue-600 group">
                             <div class="bg-blue-100 text-blue-600 p-2.5 rounded-full group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                             </div>
                             <div class="flex-1">
                                 <p class="text-xs text-gray-500 mb-0.5" data-i18n="thPhone">電話 (點擊撥打)</p>
                                 <p class="font-mono text-[15px] font-medium" id="modalPhoneText">Phone</p>
                             </div>
                         </a>
                         <button id="btnCopyPhone" class="p-3 -mr-1 text-gray-400 hover:text-blue-600 transition-colors" title="複製"></button>
                     </div>
                     <!-- 電子郵件區塊 -->
                     <div class="flex items-center gap-3 bg-gray-50/80 p-3 rounded-xl border border-gray-100">
                         <a id="modalEmailLink" href="" class="flex-1 flex items-center gap-3 text-gray-800 hover:text-blue-600 group overflow-hidden">
                             <div class="bg-blue-100 text-blue-600 p-2.5 rounded-full group-hover:bg-blue-600 group-hover:text-white transition-colors shrink-0">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                             </div>
                             <div class="flex-1 min-w-0">
                                 <p class="text-xs text-gray-500 mb-0.5" data-i18n="thEmail">電子郵件 (點擊發信)</p>
                                 <p class="font-medium text-[15px] truncate block w-full" id="modalEmailText">Email</p>
                             </div>
                         </a>
                         <button id="btnCopyEmail" class="p-3 -mr-1 text-gray-400 hover:text-blue-600 transition-colors shrink-0" title="複製"></button>
                     </div>
                     <!-- 地址區塊 -->
                     <div class="flex items-start gap-3 bg-gray-50/80 p-3 rounded-xl border border-gray-100">
                         <div class="flex-1 flex items-start gap-3 text-gray-800">
                             <div class="bg-blue-100 text-blue-600 p-2.5 rounded-full mt-0.5 shrink-0">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                             </div>
                             <div class="flex-1">
                                 <p class="text-xs text-gray-500 mb-1" data-i18n="thAddress">地址</p>
                                 <p class="font-medium text-[14px] leading-relaxed text-gray-700" id="modalAddressText">Address</p>
                             </div>
                         </div>
                         <button id="btnCopyAddress" class="p-3 -mr-1 mt-1 text-gray-400 hover:text-blue-600 transition-colors shrink-0" title="複製"></button>
                     </div>
                 </div>
             </div>
             <div class="px-6 py-5 bg-white border-t border-gray-100 mt-auto shadow-[0_-15px_30px_rgba(0,0,0,0.03)] pb-8 md:pb-5">
                 <button id="modalDownloadBtn" class="w-full flex justify-center items-center gap-2.5 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white py-4 rounded-xl font-medium transition-all shadow-md shadow-blue-200 text-[15px]">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0H4m16 0 1.28 2.55a1 1 0 0 1-.9 1.45H3.62a1 1 0 0 1-.9-1.45L4 16"/><path d="M12 12v6"/><path d="m9 15 3 3 3-3"/></svg>
                     <span data-i18n="addToContacts">加入通訊錄 (VCF)</span>
                 </button>
             </div>
        </div>
    </div>

    <script>
        const copyIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
        const checkIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;

        // 資料狀態與分頁設定
        let allContacts = [];
        let filteredContacts = [];
        let currentPage = 1;
        const itemsPerPage = 20;

        const i18n = {
            zh: {
                pageTitle: "聯絡人管理",
                title: "聯絡人列表",
                subtitle: "點擊聯絡人以查看詳細資訊或加入通訊錄",
                exportBtn: "匯出 XLSX",
                searchPlaceholder: "搜尋姓名或公司...",
                thName: "姓名",
                thTitle: "職位",
                thCompany: "公司",
                thPhone: "電話 (點擊撥打)",
                thEmail: "電子郵件 (點擊發信)",
                thAddress: "地址",
                addToContacts: "加入通訊錄 (VCF)",
                excelSheetName: "聯絡人資料",
                excelFilename: "聯絡人列表.xlsx",
                noData: "目前沒有符合條件的資料。",
                loading: "資料載入中...",
                loadError: "資料載入失敗，請確認網路狀態。",
                btnPrev: "上一頁",
                btnNext: "下一頁"
            },
            en: {
                pageTitle: "Contact Management",
                title: "Contact List",
                subtitle: "Tap a contact to view details or add to contacts",
                exportBtn: "Export XLSX",
                searchPlaceholder: "Search name or company...",
                thName: "Name",
                thTitle: "Title",
                thCompany: "Company",
                thPhone: "Phone (Tap to call)",
                thEmail: "Email (Tap to send)",
                thAddress: "Address",
                addToContacts: "Add to Contacts (VCF)",
                excelSheetName: "Contacts",
                excelFilename: "Contact_List.xlsx",
                noData: "No matching data available.",
                loading: "Loading data...",
                loadError: "Failed to load data. Please check network.",
                btnPrev: "Previous",
                btnNext: "Next"
            }
        };

        let currentLang = 'en';

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang === 'zh' ? 'zh-TW' : 'en';
            
            document.getElementById('btn-zh').className = lang === 'zh' ? 'px-3 py-1 text-sm rounded-md font-medium transition-colors bg-blue-600 text-white shadow-sm' : 'px-3 py-1 text-sm rounded-md font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-sm';
            document.getElementById('btn-en').className = lang === 'en' ? 'px-3 py-1 text-sm rounded-md font-medium transition-colors bg-blue-600 text-white shadow-sm' : 'px-3 py-1 text-sm rounded-md font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-sm';

            document.getElementById('pageTitle').textContent = i18n[lang].pageTitle;
            document.getElementById('searchInput').placeholder = i18n[lang].searchPlaceholder;
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang][key]) el.textContent = i18n[lang][key];
            });

            if (allContacts.length > 0) renderTable();
        }

        // ================= 搜尋與分頁邏輯 =================
        function handleSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!query) {
                filteredContacts = [...allContacts];
            } else {
                filteredContacts = allContacts.filter(contact => {
                    const name = (contact.name || '').toLowerCase();
                    const company = (contact.company || '').toLowerCase();
                    return name.includes(query) || company.includes(query);
                });
            }
            
            currentPage = 1; // 搜尋後重置回第一頁
            renderTable();
        }

        function changePage(delta) {
            currentPage += delta;
            renderTable();
            // 切換頁面後平滑滾動回表格頂部
            document.getElementById('contactTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }


        // ================= 彩蛋與自動載入邏輯 =================
        let logoClickCount = 0;
        let clickTimer = null;

        function handleLogoClick() {
            logoClickCount++;
            clearTimeout(clickTimer);
            if (logoClickCount === 7) {
                window.open('https://docs.google.com/spreadsheets/d/17OU8cnurpmkL4ItJKOGPP-x3M__byfb0iweLAk8_Nh4/edit?usp=sharing', '_blank');
                logoClickCount = 0;
            } else {
                clickTimer = setTimeout(() => { logoClickCount = 0; }, 1000); 
            }
        }

        function showLoadError() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-500">${i18n[currentLang].loadError}</td></tr>`;
        }

        window.google = window.google || {};
        window.google.visualization = window.google.visualization || {};
        window.google.visualization.Query = window.google.visualization.Query || {};
        window.google.visualization.Query.setResponse = function(response) {
            if (typeof window.handleGoogleJSONP === 'function') {
                window.handleGoogleJSONP(response);
            }
        };

        window.handleGoogleJSONP = function(response) {
            clearTimeout(window.jsonpTimeout);
            try {
                let textToParse = "";
                if (response && response.table && response.table.rows) {
                    response.table.rows.forEach(row => {
                        if (row.c) {
                            row.c.forEach(cell => {
                                if (cell && typeof cell.v === 'string') {
                                    textToParse += cell.v + "\n";
                                }
                            });
                        }
                    });
                }
                
                if (!textToParse.includes('BEGIN:VCARD')) {
                    throw new Error("No VCF data found");
                }
                
                textToParse = textToParse.replace(/""/g, '"');
                extractAndParseVCFs(textToParse);
            } catch (err) {
                console.warn('Google JSONP parsing failed, trying fallback...', err);
                loadFallbackJSONP();
            }
        };

        window.handleAllOriginsJSONP = function(data) {
            clearTimeout(window.fallbackTimeout);
            try {
                if (data && data.contents) {
                    let textToParse = data.contents.replace(/""/g, '"');
                    extractAndParseVCFs(textToParse);
                } else {
                    throw new Error("Empty contents from proxy");
                }
            } catch (err) {
                console.error('Fallback Error:', err);
                showLoadError();
            }
        };

        function loadFallbackJSONP() {
            const targetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTu3Bmjh7EMQksVsStTCW2ppS8MXcAhII7BLtvy5b0zorsU0Qkz0lNx9faPxSb8Tv5LnxjZtz5su47V/pub?output=csv";
            const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(targetUrl) + "&callback=handleAllOriginsJSONP";
            
            const script = document.createElement('script');
            script.src = proxyUrl;
            script.onerror = showLoadError;
            
            window.fallbackTimeout = setTimeout(showLoadError, 10000);
            document.body.appendChild(script);
        }

        function autoLoadData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">${i18n[currentLang].loading}</td></tr>`;

            const docId = '17OU8cnurpmkL4ItJKOGPP-x3M__byfb0iweLAk8_Nh4';
            const gvizUrl = `https://docs.google.com/spreadsheets/d/${docId}/gviz/tq?tqx=out:json;responseHandler:handleGoogleJSONP`;
            
            const script = document.createElement('script');
            script.src = gvizUrl;
            
            script.onerror = () => {
                console.warn('Google script load blocked, trying fallback...');
                clearTimeout(window.jsonpTimeout);
                loadFallbackJSONP();
            };

            window.jsonpTimeout = setTimeout(() => {
                console.warn('Google script timeout, trying fallback...');
                loadFallbackJSONP();
            }, 8000);

            document.body.appendChild(script);
        }

        function extractAndParseVCFs(text) {
            const vcardRegex = /BEGIN:VCARD[\s\S]*?END:VCARD/gi;
            const matches = text.match(vcardRegex);

            if (!matches || matches.length === 0) {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">${i18n[currentLang].noData}</td></tr>`;
                return;
            }

            const parsedContacts = [];

            matches.forEach(vcf => {
                const getMatch = (regex) => {
                    const m = vcf.match(regex);
                    return m ? m[1].trim() : '';
                };

                let rawAddress = getMatch(/^ADR[^:]*:(.*)$/im);
                let formattedAddress = rawAddress ? rawAddress.replace(/^;+/, '').replace(/;/g, ', ').replace(/\\,/g, ',') : '';

                parsedContacts.push({
                    name: getMatch(/^FN:(.*)$/im),
                    company: getMatch(/^ORG:(.*)$/im),
                    title: getMatch(/^TITLE:(.*)$/im),
                    phone: getMatch(/^TEL[^:]*:(.*)$/im),
                    email: getMatch(/^EMAIL[^:]*:(.*)$/im),
                    address: formattedAddress,
                    website: getMatch(/^URL[^:]*:(.*)$/im).replace(/^https?:\/\//i, '')
                });
            });

            // 存入全域資料並觸發首次搜尋與渲染
            allContacts = parsedContacts;
            handleSearch();
        }

        // ================= 渲染與互動邏輯 =================

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const paginationEl = document.getElementById('pagination');
            tbody.innerHTML = '';
            
            if (filteredContacts.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">${i18n[currentLang].noData}</td></tr>`;
                paginationEl.classList.add('hidden');
                return;
            }

            paginationEl.classList.remove('hidden');

            // 計算分頁參數
            const totalItems = filteredContacts.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);

            // 截取當前頁面的資料
            const pageContacts = filteredContacts.slice(startIndex, endIndex);

            pageContacts.forEach((contact, pageIndex) => {
                const absoluteIndex = startIndex + pageIndex; // 傳入經過篩選後的絕對索引
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50 transition-colors duration-150 cursor-pointer active:bg-blue-100 md:active:bg-transparent';
                tr.onclick = (e) => {
                    if(e.target.closest('a') || e.target.closest('button')) return;
                    openModal(absoluteIndex);
                };
                
                tr.innerHTML = `
                    <td class="p-3 md:p-4 font-medium text-gray-900 align-middle">${contact.name || '-'}</td>
                    <td class="p-3 md:p-4 text-gray-600 text-xs md:text-sm align-middle">${contact.title || '-'}</td>
                    <td class="p-3 md:p-4 text-gray-800 text-xs md:text-sm font-medium align-middle">${contact.company || '-'}</td>
                    <td class="p-4 font-mono text-xs hidden md:table-cell align-middle">${contact.phone || '-'}</td>
                    <td class="p-4 hidden md:table-cell align-middle"><a href="mailto:${contact.email}" class="text-blue-600 hover:underline block truncate w-40 lg:w-auto">${contact.email || '-'}</a></td>
                    <td class="p-4 hidden lg:table-cell text-xs text-gray-500 max-w-[200px] xl:max-w-xs truncate align-middle" title="${contact.address}">${contact.address || '-'}</td>
                    <td class="p-3 text-right md:hidden align-middle text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block"><path d="m9 18 6-6-6-6"/></svg>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // 更新分頁 UI 與文字
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages;
            
            const infoTextZh = `顯示第 ${startIndex + 1} 至 ${endIndex} 筆，共 ${totalItems} 筆`;
            const infoTextEn = `Showing ${startIndex + 1} to ${endIndex} of ${totalItems} entries`;
            document.getElementById('pageInfo').textContent = currentLang === 'zh' ? infoTextZh : infoTextEn;
        }

        function openModal(index) {
            // 使用 filteredContacts 確保點擊彈窗的資料符合當前搜尋條件
            const contact = filteredContacts[index];
            
            document.getElementById('modalName').textContent = contact.name || 'Unknown';
            document.getElementById('modalCompany').textContent = contact.company || '-';
            document.getElementById('modalTitle').textContent = contact.title || '-';
            
            const phoneClean = (contact.phone || '').replace(/[^0-9+]/g, '');
            document.getElementById('modalPhoneText').textContent = contact.phone || '-';
            document.getElementById('modalPhoneLink').href = contact.phone ? `tel:${phoneClean}` : '#';
            
            document.getElementById('modalEmailText').textContent = contact.email || '-';
            document.getElementById('modalEmailLink').href = contact.email ? `mailto:${contact.email}` : '#';
            
            document.getElementById('modalAddressText').textContent = contact.address || '-';
            
            document.getElementById('modalDownloadBtn').onclick = () => downloadVCF(index);

            setupCopyButton('btnCopyPhone', contact.phone || '');
            setupCopyButton('btnCopyEmail', contact.email || '');
            setupCopyButton('btnCopyAddress', contact.address || '');

            document.getElementById('contactModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('contactModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function setupCopyButton(btnId, textToCopy) {
            const btn = document.getElementById(btnId);
            btn.innerHTML = copyIconSvg;
            btn.className = "p-3 -mr-1 text-gray-400 hover:text-blue-600 transition-colors shrink-0";
            
            if(!textToCopy) {
                btn.style.opacity = '0.3';
                btn.onclick = null;
                return;
            }
            btn.style.opacity = '1';

            btn.onclick = () => {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    btn.innerHTML = checkIconSvg;
                    btn.classList.remove('text-gray-400', 'hover:text-blue-600');
                    btn.classList.add('text-green-600', 'bg-green-50', 'rounded-lg');
                    setTimeout(() => {
                        btn.innerHTML = copyIconSvg;
                        btn.classList.remove('text-green-600', 'bg-green-50', 'rounded-lg');
                        btn.classList.add('text-gray-400', 'hover:text-blue-600');
                    }, 2000);
                } catch (err) {}
                document.body.removeChild(textArea);
            };
        }

        function downloadVCF(index) {
            const contact = filteredContacts[index];
            const vcardContent = `BEGIN:VCARD
VERSION:3.0
FN:${contact.name || ''}
ORG:${contact.company || ''}
TITLE:${contact.title || ''}
TEL;TYPE=WORK,VOICE:${contact.phone || ''}
EMAIL;TYPE=PREF,INTERNET:${contact.email || ''}
ADR;TYPE=WORK:;;${(contact.address || '').replace(/,/g, ';')}
URL:http://${contact.website || ''}
END:VCARD`;

            const blob = new Blob([vcardContent], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${(contact.name || 'contact').replace(/\s+/g, '_')}.vcf`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        function exportToExcel() {
            // 只匯出當前搜尋過濾後的資料，而非原始全數資料
            if(filteredContacts.length === 0) return;
            const t = i18n[currentLang];
            const exportData = filteredContacts.map(c => ({
                [t.thName]: c.name,
                [t.thTitle]: c.title,
                [t.thCompany]: c.company,
                [t.thPhone]: c.phone,
                [t.thEmail]: c.email,
                [t.thAddress]: c.address,
                "Website": c.website
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, t.excelSheetName);
            const wscols = [
                {wch: 20}, {wch: 45}, {wch: 30}, {wch: 20}, {wch: 35}, {wch: 60}, {wch: 25}
            ];
            worksheet['!cols'] = wscols;
            XLSX.writeFile(workbook, t.excelFilename);
        }

        document.addEventListener('DOMContentLoaded', () => {
            setLanguage('en'); 
            autoLoadData();
        });
    </script>
</body>
</html>